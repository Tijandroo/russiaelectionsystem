<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Roblox Election Voting</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #2c2c2c 0%, #1a1a1a 100%);
            color: #e0e0e0;
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            width: 100%;
            background: rgba(40, 40, 40, 0.95);
            border-radius: 20px;
            overflow: hidden;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
            border: 1px solid #444;
        }
        
        .login-screen {
            padding: 50px;
            text-align: center;
        }
        
        .login-screen h1 {
            font-size: 2.8rem;
            margin-bottom: 20px;
            color: #ffffff;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .login-screen h1 i {
            color: #00a2ff;
            margin-right: 15px;
        }
        
        .login-screen p {
            font-size: 1.2rem;
            color: #b0b0b0;
            margin-bottom: 40px;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
            line-height: 1.6;
        }
        
        .roblox-login-btn {
            background: linear-gradient(135deg, #00a2ff, #0088cc);
            color: white;
            border: none;
            padding: 20px 40px;
            font-size: 1.3rem;
            font-weight: bold;
            border-radius: 50px;
            cursor: pointer;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 8px 25px rgba(0, 162, 255, 0.3);
        }
        
        .roblox-login-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 162, 255, 0.4);
            background: linear-gradient(135deg, #0088cc, #00a2ff);
        }
        
        .login-info {
            margin-top: 40px;
            padding: 20px;
            background: rgba(60, 60, 60, 0.5);
            border-radius: 10px;
            border-left: 4px solid #00a2ff;
            text-align: left;
            max-width: 600px;
            margin-left: auto;
            margin-right: auto;
        }
        
        .login-info h3 {
            color: #00a2ff;
            margin-bottom: 10px;
            font-size: 1.2rem;
        }
        
        .login-info ul {
            list-style: none;
            padding-left: 20px;
        }
        
        .login-info li {
            margin-bottom: 8px;
            color: #cccccc;
        }
        
        .login-info li i {
            color: #00a2ff;
            margin-right: 10px;
        }
        
        .voting-screen {
            display: none;
            padding: 30px;
        }
        
        .user-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: rgba(60, 60, 60, 0.7);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 30px;
            border: 1px solid #444;
        }
        
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        
        .user-avatar {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            border: 3px solid #00a2ff;
            overflow: hidden;
        }
        
        .user-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-details h2 {
            color: #ffffff;
            font-size: 1.8rem;
            margin-bottom: 5px;
        }
        
        .user-details p {
            color: #b0b0b0;
            font-size: 1rem;
        }
        
        .logout-btn {
            background: #ff4757;
            color: white;
            border: none;
            padding: 10px 25px;
            border-radius: 50px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .logout-btn:hover {
            background: #ff3742;
            transform: scale(1.05);
        }
        
        .voting-container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }
        
        .candidate-list {
            flex: 2;
            min-width: 300px;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 25px;
        }
        
        .results-panel {
            flex: 1;
            min-width: 300px;
            background: rgba(45, 45, 45, 0.9);
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.3);
            border: 1px solid #444;
        }
        
        .results-panel h2 {
            font-size: 1.5rem;
            margin-bottom: 20px;
            color: #ffffff;
            padding-bottom: 10px;
            border-bottom: 2px solid #00a2ff;
        }
        
        .results-container {
            max-height: 400px;
            overflow-y: auto;
        }
        
        .result-item {
            background: rgba(60, 60, 60, 0.7);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
            border-left: 4px solid #00a2ff;
        }
        
        .result-name {
            font-size: 1.1rem;
            color: #ffffff;
            margin-bottom: 5px;
        }
        
        .result-votes {
            font-size: 1.3rem;
            font-weight: bold;
            color: #00ff88;
        }
        
        .result-bar {
            height: 6px;
            background: #444;
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }
        
        .result-fill {
            height: 100%;
            background: linear-gradient(90deg, #00a2ff, #00ff88);
            border-radius: 3px;
        }
        
        .candidate-card {
            background: rgba(45, 45, 45, 0.9);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 1px solid #444;
            position: relative;
        }
        
        .candidate-card.voted {
            border-color: #00ff88;
            box-shadow: 0 0 0 2px rgba(0, 255, 136, 0.3);
        }
        
        .avatar-container {
            width: 140px;
            height: 140px;
            margin: 0 auto 15px;
            border-radius: 50%;
            overflow: hidden;
            border: 4px solid #00a2ff;
            background: #2c2c2c;
        }
        
        .avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .candidate-name {
            font-size: 1.4rem;
            margin-bottom: 5px;
            color: #ffffff;
        }
        
        .vote-count {
            font-size: 1.2rem;
            margin: 15px 0;
            color: #00ff88;
            font-weight: bold;
        }
        
        .vote-btn {
            background: linear-gradient(135deg, #00a2ff, #0088cc);
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            font-size: 1rem;
        }
        
        .vote-btn:disabled {
            background: #444;
            cursor: not-allowed;
        }
        
        .vote-btn.voted {
            background: linear-gradient(135deg, #00ff88, #00cc6a);
        }
        
        .total-votes {
            text-align: center;
            margin-top: 20px;
            padding: 15px;
            background: rgba(60, 60, 60, 0.7);
            border-radius: 10px;
            font-size: 1.1rem;
            color: #ffffff;
            border: 1px solid #444;
        }
        
        .total-votes strong {
            color: #00ff88;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            color: #b0b0b0;
            grid-column: 1 / -1;
        }
        
        footer {
            text-align: center;
            padding: 20px;
            margin-top: 30px;
            color: #888;
            font-size: 0.9rem;
            border-top: 1px solid #444;
        }
        
        .error-message {
            background: rgba(255, 71, 87, 0.1);
            border: 1px solid #ff4757;
            color: #ff6b6b;
            padding: 15px;
            border-radius: 10px;
            margin: 20px auto;
            max-width: 600px;
            display: none;
        }
        
        @media (max-width: 768px) {
            .voting-container {
                flex-direction: column;
            }
            
            .candidate-list {
                grid-template-columns: 1fr;
            }
            
            .login-screen h1 {
                font-size: 2.2rem;
            }
            
            .roblox-login-btn {
                padding: 15px 30px;
                font-size: 1.1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div id="loginScreen" class="login-screen">
            <h1><i class="fab fa-roblox"></i> Roblox Election Voting</h1>
            <p>You must sign in with your Roblox account to vote in the election. One vote per account.</p>
            
            <button id="robloxLoginBtn" class="roblox-login-btn">
                <i class="fab fa-roblox"></i>
                Sign in with Roblox
            </button>
            
            <div class="login-info">
                <h3><i class="fas fa-shield-alt"></i> Real OAuth 2.0 Authentication</h3>
                <ul>
                    <li><i class="fas fa-check-circle"></i> Official Roblox OAuth 2.0 flow</li>
                    <li><i class="fas fa-check-circle"></i> Redirects to Roblox.com for authentication</li>
                    <li><i class="fas fa-check-circle"></i> Secure token exchange via backend</li>
                    <li><i class="fas fa-check-circle"></i> One vote per verified Roblox account</li>
                </ul>
            </div>
            
            <div id="errorMessage" class="error-message">
                <h3><i class="fas fa-exclamation-triangle"></i> Error</h3>
                <p id="errorMessageText"></p>
            </div>
        </div>
        
        <div id="votingScreen" class="voting-screen">
            <div class="user-header">
                <div class="user-info">
                    <div class="user-avatar">
                        <img id="loggedInAvatar" src="" alt="User Avatar">
                    </div>
                    <div class="user-details">
                        <h2 id="loggedInUsername">Username</h2>
                        <p id="loggedInUserId">ID: Loading...</p>
                    </div>
                </div>
                <button id="logoutBtn" class="logout-btn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            
            <div class="voting-container">
                <div id="candidate-list" class="candidate-list">
                    <div class="loading">
                        <i class="fas fa-spinner fa-spin"></i>
                        <p>Loading candidates...</p>
                    </div>
                </div>
                
                <div class="results-panel">
                    <h2><i class="fas fa-chart-bar"></i> Current Results</h2>
                    <div id="results-container" class="results-container">
                        <div class="loading">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p>Loading results...</p>
                        </div>
                    </div>
                    <div id="total-votes-element" class="total-votes">
                        <strong>0</strong> total votes cast
                    </div>
                </div>
            </div>
            
            <footer>
                <p>Roblox Election Voting System | Real OAuth 2.0 Authentication</p>
            </footer>
        </div>
    </div>

    <script>
        // ============================================
        // CONFIGURATION
        // ============================================
        
        // Backend API URL - You must host the server.js file
        const BACKEND_URL = "https://your-backend-server.com"; // CHANGE THIS
        
        // Candidates configuration
        const CANDIDATES_CONFIG = [
            {
                id: "156",
                name: "Builderman",
                description: "Roblox Founder & CEO",
                avatarUrl: "https://tr.rbxcdn.com/bcdee8ac9a5a31a4759b448da7c9ff7e/150/150/AvatarHeadshot/Png"
            },
            {
                id: "261",
                name: "Telamon",
                description: "Community Manager",
                avatarUrl: "https://tr.rbxcdn.com/ed48128a86ab6cc04537207640f3e5a8/150/150/AvatarHeadshot/Png"
            },
            {
                id: "1134911",
                name: "Rukiryo",
                description: "Game Developer",
                avatarUrl: "https://tr.rbxcdn.com/9e7d0c3a4f81d4fa6864c5e755f1b150/150/150/AvatarHeadshot/Png"
            }
        ];
    </script>

    <script>
        // ============================================
        // REAL Roblox OAuth 2.0 Voting System
        // ============================================
        
        class VotingSystem {
            constructor() {
                this.candidates = [];
                this.currentUser = null;
                this.accessToken = null;
                this.init();
            }
            
            init() {
                // Set up event listeners
                document.getElementById('robloxLoginBtn').addEventListener('click', () => this.startOAuth());
                document.getElementById('logoutBtn').addEventListener('click', () => this.logout());
                
                // Check for OAuth callback in URL
                this.handleAuthCallback();
                
                // Check if already logged in
                const savedUser = localStorage.getItem('roblox_user');
                const savedToken = localStorage.getItem('roblox_token');
                
                if (savedUser && savedToken) {
                    this.currentUser = JSON.parse(savedUser);
                    this.accessToken = savedToken;
                    this.showVotingScreen();
                    this.loadCandidates();
                } else {
                    this.showLoginScreen();
                }
            }
            
            // Start OAuth flow - redirects to backend auth endpoint
            startOAuth() {
                if (!BACKEND_URL || BACKEND_URL === "https://your-backend-server.com") {
                    this.showError("Backend server not configured. Please set BACKEND_URL in the script.");
                    return;
                }
                
                // Generate state for security
                const state = this.generateState();
                localStorage.setItem('oauth_state', state);
                
                // Redirect to backend auth endpoint
                window.location.href = `${BACKEND_URL}/auth/roblox?state=${encodeURIComponent(state)}&redirect_uri=${encodeURIComponent(window.location.href)}`;
            }
            
            // Handle OAuth callback from backend
            async handleAuthCallback() {
                const urlParams = new URLSearchParams(window.location.search);
                const code = urlParams.get('code');
                const state = urlParams.get('state');
                const error = urlParams.get('error');
                
                if (error) {
                    this.showError(`Authentication failed: ${error}`);
                    return;
                }
                
                if (code && state) {
                    // Verify state
                    const savedState = localStorage.getItem('oauth_state');
                    if (state !== savedState) {
                        this.showError("Security error: State mismatch");
                        return;
                    }
                    
                    // Exchange code for tokens via backend
                    try {
                        const response = await fetch(`${BACKEND_URL}/auth/token`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            body: JSON.stringify({ code, redirect_uri: window.location.origin + window.location.pathname })
                        });
                        
                        if (!response.ok) {
                            throw new Error('Token exchange failed');
                        }
                        
                        const data = await response.json();
                        this.accessToken = data.access_token;
                        
                        // Get user info
                        await this.fetchUserInfo();
                        
                        // Clean URL
                        window.history.replaceState({}, document.title, window.location.pathname);
                        
                    } catch (error) {
                        this.showError('Failed to authenticate. Please try again.');
                    }
                }
            }
            
            // Fetch user info from Roblox API using access token
            async fetchUserInfo() {
                try {
                    // Get user info from Roblox OAuth endpoint
                    const userResponse = await fetch('https://apis.roblox.com/oauth/v1/userinfo', {
                        headers: {
                            'Authorization': `Bearer ${this.accessToken}`
                        }
                    });
                    
                    if (!userResponse.ok) {
                        throw new Error('Failed to fetch user info');
                    }
                    
                    const userInfo = await userResponse.json();
                    
                    // Get avatar
                    const avatarUrl = await this.getUserAvatar(userInfo.sub);
                    
                    this.currentUser = {
                        id: userInfo.sub,
                        username: userInfo.preferred_username,
                        displayName: userInfo.name || userInfo.preferred_username,
                        avatarUrl: avatarUrl
                    };
                    
                    // Save to localStorage
                    localStorage.setItem('roblox_user', JSON.stringify(this.currentUser));
                    localStorage.setItem('roblox_token', this.accessToken);
                    
                    this.showVotingScreen();
                    this.loadCandidates();
                    
                } catch (error) {
                    this.showError('Failed to load user information.');
                }
            }
            
            // Get user avatar from Roblox API
            async getUserAvatar(userId) {
                try {
                    const response = await fetch(`https://thumbnails.roblox.com/v1/users/avatar-headshot?userIds=${userId}&size=150x150&format=Png&isCircular=true`);
                    const data = await response.json();
                    
                    if (data.data && data.data[0]) {
                        return data.data[0].imageUrl;
                    }
                } catch (error) {
                    console.error('Failed to fetch avatar:', error);
                }
                
                // Fallback avatar
                return `https://via.placeholder.com/150/00a2ff/ffffff?text=${userId.slice(0, 1)}`;
            }
            
            logout() {
                if (confirm('Are you sure you want to logout?')) {
                    localStorage.removeItem('roblox_user');
                    localStorage.removeItem('roblox_token');
                    localStorage.removeItem('oauth_state');
                    
                    this.currentUser = null;
                    this.accessToken = null;
                    
                    this.showLoginScreen();
                }
            }
            
            loadCandidates() {
                // Use configured candidates (due to CORS restrictions)
                this.candidates = CANDIDATES_CONFIG.map(candidate => {
                    // Load votes from localStorage
                    const votes = parseInt(localStorage.getItem(`votes_${candidate.id}`)) || 0;
                    
                    // Check if current user voted for this candidate
                    let userVoted = false;
                    if (this.currentUser) {
                        const userVotes = JSON.parse(localStorage.getItem(`user_votes_${this.currentUser.id}`)) || [];
                        userVoted = userVotes.includes(candidate.id);
                    }
                    
                    return {
                        ...candidate,
                        votes: votes,
                        userVoted: userVoted
                    };
                });
                
                this.renderCandidates();
                this.renderResults();
                
                // Update user info display
                if (this.currentUser) {
                    document.getElementById('loggedInUsername').textContent = this.currentUser.username;
                    document.getElementById('loggedInUserId').textContent = `ID: ${this.currentUser.id}`;
                    document.getElementById('loggedInAvatar').src = this.currentUser.avatarUrl;
                }
            }
            
            vote(candidateId) {
                if (!this.currentUser) {
                    this.showError("You must be logged in to vote.");
                    return;
                }
                
                // Check if user already voted
                const userVotes = JSON.parse(localStorage.getItem(`user_votes_${this.currentUser.id}`)) || [];
                if (userVotes.length > 0) {
                    this.showError("You have already voted. One vote per account.");
                    return;
                }
                
                // Find candidate
                const candidate = this.candidates.find(c => c.id === candidateId);
                if (!candidate) return;
                
                // Update votes
                candidate.votes++;
                candidate.userVoted = true;
                
                // Save to localStorage
                localStorage.setItem(`votes_${candidateId}`, candidate.votes.toString());
                
                userVotes.push(candidateId);
                localStorage.setItem(`user_votes_${this.currentUser.id}`, JSON.stringify(userVotes));
                
                // Update UI
                this.renderCandidates();
                this.renderResults();
                
                // Show success message
                alert(`✅ You voted for ${candidate.name}!`);
            }
            
            showLoginScreen() {
                document.getElementById('loginScreen').style.display = 'block';
                document.getElementById('votingScreen').style.display = 'none';
            }
            
            showVotingScreen() {
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('votingScreen').style.display = 'block';
            }
            
            showError(message) {
                const errorDiv = document.getElementById('errorMessage');
                const errorText = document.getElementById('errorMessageText');
                
                errorText.textContent = message;
                errorDiv.style.display = 'block';
                
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 5000);
            }
            
            renderCandidates() {
                const container = document.getElementById('candidate-list');
                
                container.innerHTML = this.candidates.map(candidate => {
                    const canVote = this.currentUser && !this.hasUserVoted();
                    
                    return `
                        <div class="candidate-card ${candidate.userVoted ? 'voted' : ''}">
                            <div class="avatar-container">
                                <img src="${candidate.avatarUrl}" alt="${candidate.name}" class="avatar-img">
                            </div>
                            <h3 class="candidate-name">${candidate.name}</h3>
                            <p>${candidate.description}</p>
                            <div class="vote-count">${candidate.votes} votes</div>
                            <button class="vote-btn ${candidate.userVoted ? 'voted' : ''}" 
                                    onclick="votingSystem.vote('${candidate.id}')"
                                    ${!canVote ? 'disabled' : ''}>
                                ${candidate.userVoted ? '✓ Voted' : 'Vote Now'}
                            </button>
                        </div>
                    `;
                }).join('');
            }
            
            renderResults() {
                const container = document.getElementById('results-container');
                const totalVotesEl = document.getElementById('total-votes-element');
                
                const sorted = [...this.candidates].sort((a, b) => b.votes - a.votes);
                const totalVotes = sorted.reduce((sum, candidate) => sum + candidate.votes, 0);
                const maxVotes = sorted.length > 0 ? Math.max(...sorted.map(c => c.votes)) : 0;
                
                container.innerHTML = sorted.map(candidate => {
                    const percentage = maxVotes > 0 ? (candidate.votes / maxVotes) * 100 : 0;
                    const totalPercentage = totalVotes > 0 ? ((candidate.votes / totalVotes) * 100).toFixed(1) : 0;
                    
                    return `
                        <div class="result-item">
                            <div class="result-name">${candidate.name}</div>
                            <div class="result-votes">${candidate.votes} votes (${totalPercentage}%)</div>
                            <div class="result-bar">
                                <div class="result-fill" style="width: ${percentage}%"></div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                totalVotesEl.innerHTML = `<strong>${totalVotes}</strong> total votes cast`;
            }
            
            hasUserVoted() {
                if (!this.currentUser) return false;
                const userVotes = JSON.parse(localStorage.getItem(`user_votes_${this.currentUser.id}`)) || [];
                return userVotes.length > 0;
            }
            
            generateState() {
                return Math.random().toString(36).substring(2) + Date.now().toString(36);
            }
        }
        
        // Initialize the system
        const votingSystem = new VotingSystem();
        window.votingSystem = votingSystem;
    </script>
</body>
</html>
